# 権限設計書

> 達成目標：最小権限 / 誤付与防止 / 監査可能性 / 運用可能性

---

## 1. ロール定義

```mermaid
mindmap
  root((👑 ロール階層))
    🔴 SYSTEM_ADMIN
      全データへのフルアクセス
      ユーザー強制削除
      システム設定変更
      全チーム閲覧・操作
      監査ログ閲覧
    🟠 TEAM_OWNER
      チーム解散・設定変更
      メンバーキック
      ロール変更権限
      要件定義の作成・編集
      AI生成の実行
    🟡 TEAM_PM
      タスク作成・削除・編集
      担当割り振り変更
      マイルストーン管理
      メンバー招待
      ロードマップ確定
    🟢 TEAM_MEMBER
      自分のタスク更新
      コメント投稿
      学習ログ記録
      要件定義への入力
      チーム情報閲覧
    🔵 GUEST
      チーム情報の閲覧のみ
      招待リンク経由で一時参加
      コメント不可
      操作系すべて不可
```

---

## 2. 画面 × ロール 権限マトリクス

### 2-1. 認証・ユーザー管理

| 画面・操作 | SYSTEM_ADMIN | TEAM_OWNER | TEAM_PM | TEAM_MEMBER | GUEST |
|-----------|:---:|:---:|:---:|:---:|:---:|
| ユーザー登録 | ✅ | ✅ | ✅ | ✅ | ✅ |
| ログイン / ログアウト | ✅ | ✅ | ✅ | ✅ | ✅ |
| 自分のプロフィール編集 | ✅ | ✅ | ✅ | ✅ | ❌ |
| 自分のスキル登録・編集 | ✅ | ✅ | ✅ | ✅ | ❌ |
| 他ユーザー詳細閲覧 | ✅ | 🔶チーム内のみ | 🔶チーム内のみ | 🔶チーム内のみ | ❌ |
| ユーザー検索 | ✅ | ❌ | ❌ | ❌ | ❌ |
| ユーザー削除 | ✅ | ❌ | ❌ | ❌ | ❌ |

### 2-2. チーム管理

| 画面・操作 | SYSTEM_ADMIN | TEAM_OWNER | TEAM_PM | TEAM_MEMBER | GUEST |
|-----------|:---:|:---:|:---:|:---:|:---:|
| チーム新規作成 | ✅ | ✅ | ❌ | ❌ | ❌ |
| チーム設定変更 | ✅ | ✅ | ❌ | ❌ | ❌ |
| チーム解散 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 招待リンク発行 | ✅ | ✅ | ✅ | ❌ | ❌ |
| メンバー招待承認 | ✅ | ✅ | ✅ | ❌ | ❌ |
| メンバーキック | ✅ | ✅ | ❌ | ❌ | ❌ |
| ロール変更 | ✅ | ✅ | ❌ | ❌ | ❌ |
| メンバー一覧閲覧 | ✅ | ✅ | ✅ | ✅ | 🔶公開チームのみ |
| チームダッシュボード閲覧 | ✅ | ✅ | ✅ | ✅ | 🔶公開チームのみ |

### 2-3. 要件定義

| 画面・操作 | SYSTEM_ADMIN | TEAM_OWNER | TEAM_PM | TEAM_MEMBER | GUEST |
|-----------|:---:|:---:|:---:|:---:|:---:|
| 要件定義ウィザード入力 | ✅ | ✅ | ✅ | ✅ | ❌ |
| 要件定義の編集・更新 | ✅ | ✅ | ✅ | ❌ | ❌ |
| 要件定義の削除 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 要件定義の閲覧 | ✅ | ✅ | ✅ | ✅ | ❌ |
| MVP範囲の変更 | ✅ | ✅ | ✅ | ❌ | ❌ |

### 2-4. AI生成・ロードマップ

| 画面・操作 | SYSTEM_ADMIN | TEAM_OWNER | TEAM_PM | TEAM_MEMBER | GUEST |
|-----------|:---:|:---:|:---:|:---:|:---:|
| AI分析実行 | ✅ | ✅ | ✅ | ❌ | ❌ |
| AI生成結果の編集 | ✅ | ✅ | ✅ | ❌ | ❌ |
| AI再生成（やり直し） | ✅ | ✅ | ✅ | ❌ | ❌ |
| ロードマップ確定 | ✅ | ✅ | ✅ | ❌ | ❌ |
| ロードマップ閲覧 | ✅ | ✅ | ✅ | ✅ | ❌ |
| 担当割り振り変更 | ✅ | ✅ | ✅ | ❌ | ❌ |

### 2-5. タスク管理

| 画面・操作 | SYSTEM_ADMIN | TEAM_OWNER | TEAM_PM | TEAM_MEMBER | GUEST |
|-----------|:---:|:---:|:---:|:---:|:---:|
| タスク作成 | ✅ | ✅ | ✅ | ❌ | ❌ |
| タスク削除 | ✅ | ✅ | ✅ | ❌ | ❌ |
| タスク編集（仕様・説明） | ✅ | ✅ | ✅ | ❌ | ❌ |
| 自分のタスクステータス更新 | ✅ | ✅ | ✅ | ✅ | ❌ |
| 他人のタスクステータス更新 | ✅ | ✅ | ✅ | ❌ | ❌ |
| タスクへのコメント | ✅ | ✅ | ✅ | ✅ | ❌ |
| コメント削除（自分） | ✅ | ✅ | ✅ | ✅ | ❌ |
| コメント削除（他人） | ✅ | ✅ | ✅ | ❌ | ❌ |
| タスク閲覧 | ✅ | ✅ | ✅ | ✅ | ❌ |

### 2-6. 学習・支援

| 画面・操作 | SYSTEM_ADMIN | TEAM_OWNER | TEAM_PM | TEAM_MEMBER | GUEST |
|-----------|:---:|:---:|:---:|:---:|:---:|
| 学習リソース閲覧 | ✅ | ✅ | ✅ | ✅ | ❌ |
| カスタム教材追加（チーム共有） | ✅ | ✅ | ✅ | ❌ | ❌ |
| 自分の学習ログ記録 | ✅ | ✅ | ✅ | ✅ | ❌ |
| 他人の学習ログ閲覧 | ✅ | ✅ | ✅ | 🔶チーム内のみ | ❌ |
| 質問テンプレート送信 | ✅ | ✅ | ✅ | ✅ | ❌ |

### 2-7. 運用・管理（SYSTEM_ADMIN専用）

| 画面・操作 | SYSTEM_ADMIN | それ以外 |
|-----------|:---:|:---:|
| 全チーム一覧閲覧 | ✅ | ❌ |
| 監査ログ閲覧 | ✅ | ❌ |
| ユーザー強制削除 | ✅ | ❌ |
| AI APIコスト確認 | ✅ | ❌ |
| システム設定変更 | ✅ | ❌ |

> 🔶 = 条件付き許可

---

## 3. ロール遷移ルール（誤付与防止）

```mermaid
flowchart TD
    NEW[新規ユーザー登録] --> MEMBER[TEAM_MEMBER\nデフォルト付与]

    MEMBER -->|チーム作成時\n自動昇格| OWNER[TEAM_OWNER]
    MEMBER -->|TEAM_OWNERが手動昇格| PM[TEAM_PM]
    MEMBER -->|招待リンク経由参加| MEMBER

    PM -->|TEAM_OWNERが降格| MEMBER
    OWNER -->|チーム譲渡| MEMBER

    OWNER -->|SYSTEM_ADMINのみ操作可| ADMIN[SYSTEM_ADMIN]

    subgraph RULE["⚠️ 誤付与防止ルール"]
        R1[自己ロール昇格は不可]
        R2[SYSTEM_ADMINは手動付与のみ]
        R3[ロール変更は操作ログに記録]
        R4[TEAM_OWNERは1チーム1名まで]
        R5[降格時は担当タスクを\n自動で未アサインに変更]
    end

    style RULE fill:#fff3cd,stroke:#ffc107
    style ADMIN fill:#ff6b6b,color:#fff
    style OWNER fill:#fd7e14,color:#fff
    style PM fill:#ffd93d,color:#333
    style MEMBER fill:#6bcb77,color:#fff
```

---

## 4. スコープ設計（リソースの見える範囲）

```mermaid
flowchart LR
    subgraph SCOPE["🔭 スコープ階層"]
        direction TB
        S1["🌐 グローバルスコープ\n（SYSTEM_ADMIN のみ）\n全ユーザー / 全チーム / 全ログ"]
        S2["👥 チームスコープ\n（TEAM_OWNER / PM / MEMBER）\n所属チームのデータのみ"]
        S3["👤 パーソナルスコープ\n（全ロール共通）\n自分のタスク / 学習ログ / プロフィール"]
        S1 --> S2 --> S3
    end

    subgraph RULE2["📌 スコープルール"]
        direction TB
        SR1["他チームのデータは存在が見えない\n（404 ではなく 403 を返す）"]
        SR2["チームメンバーは同チームの\n他メンバー情報のみ閲覧可"]
        SR3["ゲストは公開フラグがある\nチームのみ閲覧可"]
    end
```

---

## 5. 監査ログ設計

```mermaid
mindmap
  root((📋 監査ログ))
    記録対象アクション
      認証系
        ログイン成功・失敗
        パスワードリセット
        アカウント削除
      チーム系
        チーム作成・解散
        メンバー招待・キック
        ロール変更
      要件・AI系
        要件定義の作成・編集・削除
        AI生成実行
        ロードマップ確定・変更
      タスク系
        タスク作成・削除
        ステータス変更
        担当変更
      管理系
        SYSTEM_ADMIN操作全件
        権限設定変更
    ログデータ構造
      who
        user_id
        email
        role_at_the_time
      what
        action_type
        resource_type
        resource_id
      when
        timestamp_utc
        session_id
      result
        success or failure
        error_code
    保持ポリシー
      通常ログ 90日間保持
      管理者操作ログ 1年間保持
      セキュリティ系 永続保持
    閲覧権限
      SYSTEM_ADMINのみ閲覧可
      ダウンロード不可
      改ざん不可 追記のみ
```

---

## 6. 実装ガイドライン（運用可能性）

```mermaid
mindmap
  root((⚙️ 実装方針))
    RBAC設計
      ロールはDBで管理
        roles テーブル
        user_roles テーブル 中間テーブル
        team_roles テーブル チーム×ロール
      ハードコードしない
        コード内にロール名を直書きしない
        権限チェックは共通関数に集約
    ミドルウェア設計
      APIレイヤーで権限チェック
        全エンドポイントに認証必須
        リソースオーナーチェック
        スコープチェック チームID一致確認
      フロントは表示制御のみ
        ボタン非表示はUX改善
        セキュリティはAPIで担保
    エラーハンドリング
      401 未認証 ログイン画面へリダイレクト
      403 権限なし 操作不可メッセージ表示
      権限エラーをログに記録
    変更に強い設計
      新ロール追加時
        DBにレコード追加のみ
        コード変更不要
      権限変更時
        管理画面から即時反映
        再デプロイ不要
```

---

## 7. 権限設計サマリー

| 達成目標 | 設計で対応した内容 |
|---------|----------------|
| **最小権限** | デフォルトはTEAM_MEMBER（最弱）、必要時のみ昇格。GUESTは閲覧のみ |
| **誤付与防止** | 自己昇格不可・SYSTEM_ADMINは手動のみ・ロール変更はTEAM_OWNERのみ |
| **監査可能性** | who/what/when/resultの4軸でログ記録・改ざん不可・閲覧はADMINのみ |
| **運用可能性** | ロールはDB管理・権限チェックは共通関数集約・新ロール追加はレコード追加のみ |
